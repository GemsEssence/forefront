<%# Determine which tab list to add to %>
<% list_id = if @activity.comment? || @activity.remark?
    "activities_list_#{@actable.id}_comments"
  elsif @activity.next_step?
    "activities_list_#{@actable.id}_next_steps"
  else
    "activities_list_#{@actable.id}_internal_notes"
  end %>

<%# Add the new activity to the appropriate tab list %>
<%= turbo_stream.prepend list_id do %>
  <% tab_activities = @activities.select { |a| 
    (@activity.comment? || @activity.remark?) ? (a.comment? || a.remark?) :
    @activity.next_step? ? a.next_step? : a.internal_note?
  } %>
  <%= render "forefront/activities/activity", activity: @activity, index: 0, total: tab_activities.length, actable: @actable %>
<% end %>

<%# Update the activities list container if it was empty before (first activity) %>
<% if @activities.length == 1 %>
  <%= turbo_stream.replace "activities_list_container_#{@actable.id}" do %>
    <%= render "forefront/activities/list", activities: @activities, actable: @actable %>
  <% end %>
<% else %>
  <%# Update tab counts and show the appropriate tab if it was empty %>
  <% comments_remarks_count = @activities.select { |a| a.comment? || a.remark? }.count %>
  <% next_steps_count = @activities.select { |a| a.next_step? }.count %>
  <% internal_notes_count = @activities.select { |a| a.internal_note? }.count %>

  <%= turbo_stream.replace "tab_comments_remarks_#{@actable.id}" do %>
    <button onclick="showTab('comments_remarks_<%= @actable.id %>')" id="tab_comments_remarks_<%= @actable.id %>" class="tab-button <%= (@activity.comment? || @activity.remark?) ? 'border-indigo-500 text-indigo-600 active' : 'border-transparent text-gray-500' %> hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
      Comments & Remarks
      <span class="ml-2 bg-gray-100 text-gray-900 py-0.5 px-2.5 rounded-full text-xs font-medium">
        <%= comments_remarks_count %>
      </span>
    </button>
  <% end %>

  <%= turbo_stream.replace "tab_next_steps_#{@actable.id}" do %>
    <button onclick="showTab('next_steps_<%= @actable.id %>')" id="tab_next_steps_<%= @actable.id %>" class="tab-button <%= @activity.next_step? ? 'border-indigo-500 text-indigo-600 active' : 'border-transparent text-gray-500' %> hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
      Next Steps
      <span class="ml-2 bg-gray-100 text-gray-900 py-0.5 px-2.5 rounded-full text-xs font-medium">
        <%= next_steps_count %>
      </span>
    </button>
  <% end %>

  <%= turbo_stream.replace "tab_internal_notes_<%= @actable.id %>" do %>
    <button onclick="showTab('internal_notes_<%= @actable.id %>')" id="tab_internal_notes_<%= @actable.id %>" class="tab-button <%= @activity.internal_note? ? 'border-indigo-500 text-indigo-600 active' : 'border-transparent text-gray-500' %> hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
      Internal Notes
      <span class="ml-2 bg-gray-100 text-gray-900 py-0.5 px-2.5 rounded-full text-xs font-medium">
        <%= internal_notes_count %>
      </span>
    </button>
  <% end %>

  <%# Show the appropriate tab content if it was empty before %>
  <% if (@activity.comment? || @activity.remark?) && comments_remarks_count == 1 %>
    <%= turbo_stream.replace "comments_remarks_#{@actable.id}" do %>
      <div id="comments_remarks_<%= @actable.id %>" class="tab-content">
        <div class="flow-root mt-4">
          <ul id="activities_list_<%= @actable.id %>_comments" class="-mb-8">
            <%= render "forefront/activities/activity", activity: @activity, index: 0, total: 1, actable: @actable %>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif @activity.next_step? && next_steps_count == 1 %>
    <%= turbo_stream.replace "next_steps_#{@actable.id}" do %>
      <div id="next_steps_<%= @actable.id %>" class="tab-content">
        <div class="flow-root mt-4">
          <ul id="activities_list_<%= @actable.id %>_next_steps" class="-mb-8">
            <%= render "forefront/activities/activity", activity: @activity, index: 0, total: 1, actable: @actable %>
          </ul>
        </div>
      </div>
    <% end %>
  <% elsif @activity.internal_note? && internal_notes_count == 1 %>
    <%= turbo_stream.replace "internal_notes_#{@actable.id}" do %>
      <div id="internal_notes_<%= @actable.id %>" class="tab-content">
        <div class="flow-root mt-4">
          <ul id="activities_list_<%= @actable.id %>_internal_notes" class="-mb-8">
            <%= render "forefront/activities/activity", activity: @activity, index: 0, total: 1, actable: @actable %>
          </ul>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>

<%# Reset the form %>
<%= turbo_stream.replace "activity_form_#{@actable.id}" do %>
  <%= render "forefront/activities/form", actable: @actable %>
<% end %>

<%# Show success message %>
<%= turbo_stream.append "flash_messages" do %>
  <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded relative mb-4" role="alert">
    <span class="block sm:inline">Activity was successfully created.</span>
    <button type="button" class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
      <span class="sr-only">Dismiss</span>
      <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
<% end %>

